  // <!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>PanitaMithico - V2</title>
  <style>
    :root {
      --cursor-size: 20px;
      --ui-blur: 26px;
      --btn-size: 50px;
      --card-radius: 24px;
    }

    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      overflow: hidden;
      background-color: #050505;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      cursor: none;
      user-select: none;
      -webkit-user-select: none;
    }

    #background-layer {
      position: fixed; inset: -8%;
      width: 116%; height: 116%;
      z-index: 1;
      pointer-events: none;
      opacity: 0.65;
      filter: blur(var(--ui-blur)) saturate(1.2) brightness(0.5);
      object-fit: cover;
      transition: opacity 1.5s ease;
    }

    #particle-canvas,
    #drawing-canvas {
      position: fixed; inset: 0;
      width: 100%; height: 100%;
    }
    #particle-canvas {
      z-index: 2;
      pointer-events: none;
      mix-blend-mode: screen; 
    }
    #drawing-canvas {
      z-index: 50;
      pointer-events: auto;
      touch-action: none;
      mix-blend-mode: screen;
    }

    .perspective-container {
      position: absolute; inset: 0;
      display: flex; justify-content: center; align-items: center;
      perspective: 1200px;
      z-index: 10;
      pointer-events: none;
    }

    .card-wrapper {
      width: 700px; max-width: 85%;
      position: relative;
      transform-style: preserve-3d;
      will-change: transform;
    }

    #video-card {
      position: relative;
      border-radius: var(--card-radius);
      background: rgba(20, 20, 20, 0.6);
      box-shadow:
        0 26px 60px rgba(0,0,0,0.7),
        0 0 0 1px rgba(255,255,255,0.08) inset;
      backdrop-filter: blur(18px);
      overflow: hidden;
      transform: translateZ(0);
      transition: box-shadow 0.3s ease;
    }

    video.main-video {
      display: block; width: 100%; height: auto;
      border-radius: var(--card-radius);
      mask-image: -webkit-radial-gradient(white, black);
    }

    .card-shine {
      position: absolute; inset: 0;
      background: radial-gradient(
        circle at var(--x, 50%) var(--y, 50%),
        rgba(255,255,255,0.18),
        transparent 60%
      );
      pointer-events: none;
      mix-blend-mode: overlay;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .card-wrapper:hover .card-shine { opacity: 1; }

    #custom-cursor {
      position: fixed;
      width: var(--cursor-size); height: var(--cursor-size);
      border: 2px solid rgba(255,255,255,0.9);
      border-radius: 50%;
      top: 0; left: 0;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 9999;
      mix-blend-mode: difference;
      transition: transform 0.1s ease-out, opacity 0.3s ease;
      will-change: transform, top, left;
      box-shadow: 0 0 10px rgba(255,255,255,0.5);
    }
    #custom-cursor.active {
      transform: translate(-50%, -50%) scale(2.2);
      background: rgba(255,255,255,0.2);
      border-color: transparent;
    }
    #custom-cursor.hidden { opacity: 0; }

    .eq-bars {
      position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%);
      display: flex; gap: 4px; z-index: 90; opacity: 0; transition: opacity 0.5s;
    }
    .eq-bar {
      width: 3px; height: 10px;
      background: white;
      border-radius: 2px;
      animation: eqBounce 1s infinite ease-in-out;
    }
    .playing .eq-bars { opacity: 0.7; }
    @keyframes eqBounce { 0%, 100% { height: 6px; } 50% { height: 18px; } }
    .eq-bar:nth-child(1) { animation-delay: 0s; }
    .eq-bar:nth-child(2) { animation-delay: 0.1s; }
    .eq-bar:nth-child(3) { animation-delay: 0.2s; }

    #audio-btn {
      position: fixed;
      bottom: 40px;
      left: 50%; transform: translateX(-50%);
      width: var(--btn-size); height: var(--btn-size);
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      cursor: none;
      z-index: 100;
      display: flex; justify-content: center; align-items: center;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      pointer-events: auto;
    }
    #audio-btn svg { width: 20px; fill: white; opacity: 0.8; transition: transform 0.3s; }
    #audio-btn:hover { background: rgba(255,255,255,0.25); transform: translateX(-50%) scale(1.1); }
    #audio-btn.muted svg { opacity: 0.5; transform: scale(0.9); }
  </style>
</head>
<body>

  <div id="custom-cursor"></div>
  <video id="background-layer" muted loop playsinline></video>
  
  <canvas id="particle-canvas"></canvas>
  <canvas id="drawing-canvas"></canvas>

  <div class="perspective-container">
    <div class="card-wrapper" id="card-wrapper">
      <div id="video-card">
        <div class="card-shine"></div>
        <video class="main-video" id="main-video" loop muted playsinline autoplay>
          <source src="Laufey.mp4" type="video/mp4" />
        </video>
      </div>
    </div>
  </div>

  <div class="eq-bars" id="eq-visual">
    <div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div>
  </div>

  <button id="audio-btn" class="muted" aria-label="Toggle Sound">
    <svg viewBox="0 0 24 24">
      <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9zM12 4L9.91 6.09 12 8.18V4z"/>
    </svg>
  </button>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const mainVideo   = document.getElementById('main-video');
  const bgVideo     = document.getElementById('background-layer');
  const cardWrapper = document.getElementById('card-wrapper');
  const shine       = document.querySelector('.card-shine');
  const cursor      = document.getElementById('custom-cursor');
  const audioBtn    = document.getElementById('audio-btn');

  const pCanvas = document.getElementById('particle-canvas');
  const dCanvas = document.getElementById('drawing-canvas');
  const pCtx = pCanvas.getContext('2d', { alpha: true, desynchronized: true });
  const dCtx = dCanvas.getContext('2d', { alpha: true });

  const smCanvas = new OffscreenCanvas(64, 64);
  const smCtx = smCanvas.getContext('2d', { willReadFrequently: true });

  let width, height, centerX, centerY;
  let audioContext, analyser, dataArray, source;

  const musicState = { bass: 0, mid: 0, treble: 0, level: 0, impact: 0 };

  const resize = () => {
    width = window.innerWidth;
    height = window.innerHeight;
    [pCanvas, dCanvas].forEach(c => { c.width = width; c.height = height; });
    centerX = width / 2;
    centerY = height / 2;
  };
  window.addEventListener('resize', resize);
  resize();

  // Fondo espejo
  const syncBgVideo = () => {
    try {
      if (mainVideo.captureStream) {
        bgVideo.srcObject = mainVideo.captureStream();
      } else {
        bgVideo.src = mainVideo.currentSrc;
      }
      bgVideo.play().catch(()=>{});
    } catch(e){}
  };
  mainVideo.addEventListener('play', syncBgVideo, { once: true });

  // Cursor + tilt
  let mouseX = centerX, mouseY = centerY;
  let cursorTimer;

  const handleInput = (x, y, isClicking) => {
    mouseX = x; mouseY = y;

    cursor.style.left = x + 'px';
    cursor.style.top  = y + 'px';
    cursor.classList.remove('hidden');
    clearTimeout(cursorTimer);
    cursorTimer = setTimeout(() => cursor.classList.add('hidden'), 2500);

    const rotateX = (centerY - y) / 25;
    const rotateY = (x - centerX) / 25;
    cardWrapper.style.transform =
      `rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(${isClicking ? 0.985 : 1})`;

    shine.style.setProperty('--x', `${(x / width) * 100}%`);
    shine.style.setProperty('--y', `${(y / height) * 100}%`);
  };

  window.addEventListener('pointermove', e => handleInput(e.clientX, e.clientY, false));
  window.addEventListener('pointerdown', e => {
    handleInput(e.clientX, e.clientY, true);
    cursor.classList.add('active');
    startDrawing(e);
  });
  window.addEventListener('pointerup', () => {
    cursor.classList.remove('active');
    stopDrawing();
  });

  // Sistema de dibujo
  let isDrawing = false;
  let lastPoint = null;

  function startDrawing(e) {
    if (e.target === audioBtn) return;
    isDrawing = true;
    lastPoint = { x: e.clientX, y: e.clientY };
  }
  function stopDrawing() { isDrawing = false; lastPoint = null; }

  function drawLoop() {
    dCtx.globalCompositeOperation = 'destination-out';
    dCtx.fillStyle = 'rgba(0, 0, 0, 0.04)';
    dCtx.fillRect(0, 0, width, height);
    
    dCtx.globalCompositeOperation = 'source-over';

    if (isDrawing && lastPoint) {
      const hue = (performance.now() * 0.15) % 360;
      
      dCtx.strokeStyle = `hsla(${hue}, 100%, 70%, 1)`;
      dCtx.lineWidth = 4;
      dCtx.lineCap = 'round';
      dCtx.lineJoin = 'round';
      
      dCtx.shadowBlur = 15; 
      dCtx.shadowColor = `hsla(${hue}, 100%, 50%, 0.8)`;

      dCtx.beginPath();
      dCtx.moveTo(lastPoint.x, lastPoint.y);
      dCtx.lineTo(mouseX, mouseY);
      dCtx.stroke();
      
      dCtx.shadowBlur = 0;
      
      lastPoint = { x: mouseX, y: mouseY };
    }
    requestAnimationFrame(drawLoop);
  }
  drawLoop();

  // Audio Logic
  async function initAudio() {
    if (audioContext) return;
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    audioContext = new AudioCtx();
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 512;
    analyser.smoothingTimeConstant = 0.8;

    source = audioContext.createMediaElementSource(mainVideo);
    source.connect(analyser);
    analyser.connect(audioContext.destination);

    dataArray = new Uint8Array(analyser.frequencyBinCount);
  }

  let prevBass = 0;
  function updateAudioAnalysis() {
    if (!analyser) return;
    analyser.getByteFrequencyData(dataArray);

    const bassRange   = dataArray.slice(0, 10);
    const midRange    = dataArray.slice(10, 80);
    const trebleRange = dataArray.slice(80, 200);

    const avg = arr => arr.reduce((a, b) => a + b, 0) / (arr.length || 1);

    const b = avg(bassRange)   / 255;
    const m = avg(midRange)    / 255;
    const t = avg(trebleRange) / 255;

    musicState.bass   += (b - musicState.bass) * 0.3;
    musicState.mid    += (m - musicState.mid) * 0.2;
    musicState.treble += (t - musicState.treble) * 0.2;
    musicState.level   = (musicState.bass + musicState.mid + musicState.treble) / 3;

    // Detector de impacto (súbita subida de graves)
    const bassDelta = musicState.bass - prevBass;
    if (bassDelta > 0.15) {
      musicState.impact = 1;
    }
    musicState.impact *= 0.92; // Decay rápido
    prevBass = musicState.bass;

    if (!mainVideo.muted && musicState.level > 0.05) {
      document.body.classList.add('playing');
    } else {
      document.body.classList.remove('playing');
    }
  }

  // Muestreo de color optimizado
  function updateSampleCanvas() {
    if (mainVideo.readyState >= 2 && mainVideo.videoWidth && mainVideo.videoHeight) {
      smCtx.drawImage(mainVideo, 0, 0, smCanvas.width, smCanvas.height);
    }
  }
  setInterval(updateSampleCanvas, 180);

  function sampleColorFromVideo() {
    const w = smCanvas.width, h = smCanvas.height;
    if (!w || !h) return { r: 255, g: 255, b: 255 };
    const x = Math.floor(Math.random() * w);
    const y = Math.floor(Math.random() * h);
    const data = smCtx.getImageData(x, y, 1, 1).data;
    return { r: data[0], g: data[1], b: data[2] };
  }

  function rgba(c, a) {
    return `rgba(${c.r},${c.g},${c.b},${a})`;
  }

  // ----------------------------------------------------------------
  // MOTOR DE PARTÍCULAS OPTIMIZADO - "UNIVERSE WITHIN"
  // Inspirado en Musicvid - Campo estelar en túnel 3D
  // ----------------------------------------------------------------
  const particles = [];
  const MAX_PARTICLES = 200; // Optimizado para rendimiento

  // Pool de colores precalculados
  const colorPalette = [];
  for (let i = 0; i < 10; i++) {
    colorPalette.push(sampleColorFromVideo());
  }
  setInterval(() => {
    const idx = Math.floor(Math.random() * colorPalette.length);
    colorPalette[idx] = sampleColorFromVideo();
  }, 500);

  class Star3D {
    constructor() {
      this.reset();
    }

    reset() {
      // Posición en espacio 3D
      const angle = Math.random() * Math.PI * 2;
      const radius = Math.random() * 500;
      
      this.x = Math.cos(angle) * radius;
      this.y = Math.sin(angle) * radius;
      this.z = Math.random() * 2000 + 1000; // Lejos al principio
      
      this.baseSize = 0.5 + Math.random() * 1.5;
      this.color = colorPalette[Math.floor(Math.random() * colorPalette.length)];
      
      // Velocidad base optimizada
      this.speedZ = 2 + Math.random() * 3;
    }

    update() {
      // Movimiento hacia la cámara (efecto túnel)
      const speedMultiplier = 1 + (musicState.bass * 4) + (musicState.impact * 8);
      this.z -= this.speedZ * speedMultiplier;

      // Resetear cuando pasa la cámara
      if (this.z < 1) {
        this.reset();
      }
    }

    draw(ctx) {
      // Proyección perspectiva optimizada
      const fov = 300;
      const scale = fov / (fov + this.z);
      
      const x2d = this.x * scale + centerX;
      const y2d = this.y * scale + centerY;
      
      // Culling - no dibujar fuera de pantalla
      if (x2d < -50 || x2d > width + 50 || y2d < -50 || y2d > height + 50) {
        return;
      }

      // Tamaño basado en profundidad y música
      const size = this.baseSize * scale * (1 + musicState.mid * 1.5);
      
      // Alpha basado en profundidad
      let alpha = 1 - (this.z / 2000);
      alpha = Math.max(0, Math.min(1, alpha));
      alpha *= (0.6 + musicState.level * 0.4);

      // Efecto de estela con impactos
      if (musicState.impact > 0.3) {
        const trailLength = 15 * musicState.impact * scale;
        const gradient = ctx.createLinearGradient(
          x2d, y2d,
          x2d + (this.x * 0.01 * scale), 
          y2d + (this.y * 0.01 * scale)
        );
        gradient.addColorStop(0, rgba(this.color, alpha * 0.8));
        gradient.addColorStop(1, rgba(this.color, 0));
        
        ctx.strokeStyle = gradient;
        ctx.lineWidth = size * 0.5;
        ctx.beginPath();
        ctx.moveTo(x2d, y2d);
        ctx.lineTo(
          x2d + (this.x * 0.01 * scale * trailLength), 
          y2d + (this.y * 0.01 * scale * trailLength)
        );
        ctx.stroke();
      }

      // Partícula central
      ctx.fillStyle = rgba(this.color, alpha);
      ctx.beginPath();
      ctx.arc(x2d, y2d, size, 0, Math.PI * 2);
      ctx.fill();

      // Brillo adicional en partículas cercanas
      if (this.z < 300 && musicState.treble > 0.5) {
        ctx.fillStyle = rgba({ r: 255, g: 255, b: 255 }, alpha * 0.5);
        ctx.beginPath();
        ctx.arc(x2d, y2d, size * 0.4, 0, Math.PI * 2);
        ctx.fill();
      }
    }
  }

  // Inicializar sistema
  for (let i = 0; i < MAX_PARTICLES; i++) {
    particles.push(new Star3D());
  }

  // Loop principal optimizado con requestAnimationFrame
  let lastTime = performance.now();
  function animateParticles(currentTime) {
    updateAudioAnalysis();

    // Limitar FPS si es necesario para optimización
    const deltaTime = currentTime - lastTime;
    if (deltaTime < 16) { // ~60 FPS
      requestAnimationFrame(animateParticles);
      return;
    }
    lastTime = currentTime;

    // Limpieza completa (sin rastro para mejor rendimiento)
    pCtx.fillStyle = 'rgba(0, 0, 0, 0.2)';
    pCtx.fillRect(0, 0, width, height);

    // Batch rendering para mejor rendimiento
    pCtx.save();
    
    // Ordenar por profundidad (opcional, costoso pero más realista)
    // particles.sort((a, b) => b.z - a.z);

    particles.forEach(p => {
      p.update();
      p.draw(pCtx);
    });

    pCtx.restore();

    requestAnimationFrame(animateParticles);
  }
  animateParticles(performance.now());

  // Audio toggle
  audioBtn.addEventListener('click', () => {
    initAudio().then(() => {
      if (audioContext.state === 'suspended') audioContext.resume();
    });

    mainVideo.muted = !mainVideo.muted;
    audioBtn.classList.toggle('muted', mainVideo.muted);

    const path = audioBtn.querySelector('path');
    if (mainVideo.muted) {
      path.setAttribute(
        'd',
        'M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9zM12 4L9.91 6.09 12 8.18V4z'
      );
    } else {
      path.setAttribute(
        'd',
        'M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z'
      );
    }
  });
});
</script>
</body>
</html>

